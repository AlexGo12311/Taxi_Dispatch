{% extends 'base.html' %}

{% block title %}Заказы{% endblock %}

{% block content %}
<div class="card">
    <h1>Заказы</h1>
    
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
        <a href="{% url 'order_create' %}" class="btn btn-success">Создать заказ</a>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; width: 300px;">
            <h3 style="margin-top: 0; margin-bottom: 10px;">Фильтры</h3>

            <form method="get" style="display: flex; flex-direction: column; gap: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Статус:</label>
                    <select name="status" class="form-control" onchange="this.form.submit()">
                        <option value="">Все статусы</option>
                        {% for value, label in status_choices %}
                            {% if status == value %}
                                <option value="{{ value }}" selected>{{ label }}</option>
                            {% else %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Стоимость:</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" name="min_price" placeholder="От"
                               value="{{ min_price }}" class="form-control" step="0.01" min="0">
                        <input type="number" name="max_price" placeholder="До"
                               value="{{ max_price }}" class="form-control" step="0.01" min="0">
                    </div>
                </div>
                <button type="submit" class="btn">Применить</button>
                <a href="{% url 'order_list' %}" class="btn btn-danger">Сбросить</a>
            </form>
        </div>
    </div>

    {% if orders_list %}
        <table class="table">
            <thead>
                <tr>
                    <th>Клиент</th>
                    <th>Автомобиль</th>
                    <th>Тариф</th>
                    <th>Дата/Время</th>
                    <th>Дистанция</th>
                    <th>Итоговая стоимость</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders_list %}
                <tr>
                    <td>
                        {% if order.customer %}
                            <a href="{% url 'customer_detail' order.customer.pk %}">{{ order.customer.full_name }}</a>
                        {% else %}
                            <span class="badge badge-warning">Не указан</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.vehicle %}
                            <a href="{% url 'vehicle_detail' order.vehicle.pk %}">{{ order.vehicle.brand }} {{ order.vehicle.model}}</a>
                        {% else %}
                            <span class="badge badge-warning">Не назначен</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.tariff %}
                            {{ order.tariff.name }}
                        {% else %}
                            <span class="badge badge-warning">Не указан</span>
                        {% endif %}
                    </td>
                    <td>{{ order.order_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ order.range }} км</td>
                    <td>
                        <strong>{{ order.total_cost|floatformat:2 }} руб.</strong>
                        <br>
                        <small style="color: #666;">
                            {% if order.tariff %}
                                ({{ order.range }} км × {{ order.tariff.cost_for_km }} руб/км)
                            {% endif %}
                        </small>
                    </td>
                    <td>
                        {% if order.status == 'in_progress' %}
                            <span class="badge badge-warning">В процессе</span>
                        {% elif order.status == 'completed' %}
                            <span class="badge badge-success">Завершен</span>
                        {% elif order.status == 'cancelled' %}
                            <span class="badge badge-danger">Отменен</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'order_detail' order.pk %}" class="btn btn-sm">Просмотр</a>
                        <a href="{% url 'order_edit' order.pk %}" class="btn btn-sm btn-warning">Изменить</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if status or min_price or max_price %}
            <div style="margin-top: 20px; padding: 10px; background: #e9ecef; border-radius: 4px;">
                <strong>Примененные фильтры:</strong>
                {% if status %}
                    <span class="badge badge-info">Статус: {{ order.get_status_display }}</span>
                {% endif %}
                {% if min_price %}
                    <span class="badge badge-info">От {{ min_price }} руб.</span>
                {% endif %}
                {% if max_price %}
                    <span class="badge badge-info">До {{ max_price }} руб.</span>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-warning">
            Заказы не найдены.
        </div>
    {% endif %}
</div>
{% endblock %}